name: Actions Step1

on:
  push:
    tags:
      - v*
  workflow_dispatch:

env:
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 检查项目分支
        uses: actions/checkout@main

      - name: 生成release标签
        id: tag
        run: |
          release_tag=redmi-ax6000-v$(date +"%Y%m%d%H%M")
          echo "release_tag=$release_tag" >> $GITHUB_OUTPUT
          echo "🎉🎉 红米AX6000: $release_tag 发布成功" > release.txt

      - name: 上传firmware到Release
        uses: softprops/action-gh-release@master
        if: env.UPLOAD_RELEASE == 'true'
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          name: ${{ steps.tag.outputs.release_tag }}
          body_path: release.txt
          files: |
            ${{ env.FIRMWARE }}/*


  delete-workflow:
    needs: [ build ]
    runs-on: ubuntu-latest
    steps:
      - name: 删除workflow运行
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 0
          keep_minimum_runs: 2
