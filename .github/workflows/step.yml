name: Actions Step1

on:
  on:
    push:
      branches:
        - main
        - 'releases/**'
  repository_dispatch:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/hanwckf/immortalwrt-mt798x
  REPO_BRANCH: openwrt-21.02
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: redmi-ax6000/.config
  DIY_P1_SH: redmi-ax6000/diy-part1.sh
  DIY_P2_SH: redmi-ax6000/diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€æŸ¥é¡¹ç›®åˆ†æ”¯
        uses: actions/checkout@main

      - name: ç”ŸæˆReleaseå˜æ›´å†…å®¹
        id: github_release
        uses: mikepenz/release-changelog-builder-action@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ç”Ÿæˆreleaseæ ‡ç­¾
        id: tag
        if: env.UPLOAD_RELEASE == 'true'
        run: |
          release_tag=redmi-ax6000-v$(date +"%Y%m%d%H%M")
          echo "release_tag=$release_tag" >> $GITHUB_OUTPUT
          echo "ğŸ‰ğŸ‰ çº¢ç±³AX6000: $release_tag å‘å¸ƒæˆåŠŸ" > release.txt
          cat release.txt
          echo " ${{steps.github_release.outputs.changelog}} " >> release.txt
          cat release.txt
          echo "status=success" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ firmwareåˆ°Release
        uses: softprops/action-gh-release@master
        if: steps.tag.outputs.status == 'success' && !cancelled()
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          name: ${{ steps.tag.outputs.release_tag }}
          body_path: release.txt
          files: |
            ${{ env.FIRMWARE }}/*


  delete-workflow:
    needs: [ build-firmware ]
    runs-on: ubuntu-latest
    steps:
      - name: åˆ é™¤workflowè¿è¡Œ
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 0
          keep_minimum_runs: 2
