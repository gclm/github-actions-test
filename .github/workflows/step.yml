name: Actions Step1

on:
  push:
    branches:
      - main
      - 'releases/**'
  workflow_dispatch:

env:
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Ê£ÄÊü•È°πÁõÆÂàÜÊîØ
        uses: actions/checkout@main
        with:
          fetch-depth: 0

      - name: ÁîüÊàêreleaseÊ†áÁ≠æ
        id: tag
        run: |
          git config --global user.email "you@example.com"
          git config --global user.name "Github Action"
        
          echo "tag: $(git --no-pager tag --sort=-creatordate)"  
          previous_tag=$(git --no-pager tag --sort=-creatordate | head -n 1)
          echo "previousTag: $previous_tag"
        
          echo "previousTag=$previous_tag" >> $GITHUB_ENV
          
          release_tag=redmi-ax6000-v$(date +"%Y%m%d%H%M")
          release_title="üéâüéâ Á∫¢Á±≥AX6000: $release_tag ÂèëÂ∏ÉÊàêÂäü"
          git tag -a $release_tag -m  "$release_title"
         
          echo "ÁîüÊàê $previous_tag Âà∞ $release_tag ÁöÑÁâàÊú¨Êó•Âøó"
          echo "release_tag=$release_tag" >> $GITHUB_OUTPUT
          echo "release_title=$release_title" >> $GITHUB_OUTPUT

      - name: Update CHANGELOG
        id: changelog
        uses: requarks/changelog-action@v1
        with:
          token: ${{ github.token }}
          tag: ${{ steps.tag.outputs.release_tag }}
          writeToFile: false

      - name: ‰∏ä‰º†firmwareÂà∞Release
        uses: softprops/action-gh-release@master
        if: env.UPLOAD_RELEASE == 'true'
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          name: ${{ steps.tag.outputs.release_title }}
          body: ${{ steps.changelog.outputs.changes }}
          files: |
            ${{ env.FIRMWARE }}/*


  delete-workflow:
    needs: [ build ]
    runs-on: ubuntu-latest
    steps:
      - name: Âà†Èô§workflowËøêË°å
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 0
          keep_minimum_runs: 2
